---
title: "Final Project"
author: "Liz Austin, Casey Gibson, and Zhengfan Wang"
date: "November 15, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Lyme Disease CDC Data
Dataset detailing cases of Lyme Disease per 100,000 population in each state for the years 2006-2016

Data source:
https://www.cdc.gov/lyme/stats/index.html


Clustering by region reference:
https://www2.census.gov/geo/pdfs/maps-data/maps/reference/us_regdiv.pdf

#Group Analysis Proposal
1. Simple Poisson Model 
2. Model with state as random effect
3. Model with state as a covariate 
4. Model with region as a random effect
5. Model with region as a covariate

*Compare*

6. Select "baseline" model to simulate data from 

#Individual Analysis Proposal

Ideas in general:

1. Gamma-poisson mixture model (neg-binom)
2. Autoregressive model on $\lambda$'s 
3. Consider adding a penalized spline
4. Priors on $\beta$'s/bayesian land
5. Simulation

###Liz
Poisson Models for Overdispersion with simulation:

  + Poisson GLM with $\hat\phi$ adjustment 
  
  + Poisson GLMM with normal random intercept
  
  + Gamma-Poisson mixture model
  
  + GEE marginal Poisson
  
###Casey
Bayesian + Autoregressive Model

###Zhengfan
Clustering + Simulation

```{r, echo=FALSE}
lyme=read.csv("lymedata.csv",header=T)

#Let 1 = Northeast
#Let 2 = Midwest
#Let 3 = South
#Let 4 = West
lyme$Region<- c(3,4,4,3,4,4,1,3,3,3,3,4,4,2,2,2,2,3,3,1,3,1,2,2,3,2,4,2,4,1,1,4,1,3,2,2,3,4,1,1,3,2,3,3,4,1,3,4,3,2,4)
lyme<- lyme[-9,]

lyme1=reshape(lyme, direction="long", varying=list(names(lyme)[2:11]), v.names="count", 
        idvar=c("state"), timevar="year", times=2006:2015)
lyme1<- lyme1[,-5]
lyme1$count<- as.numeric(lyme1$count)

mod1<- glm(count~year,data=lyme1,family=poisson)

mod2<- glm(count~year+State,data=lyme1,family=poisson) 

mod3<- glm(count~year+Region,data=lyme1,family=poisson) 

anova(mod2,mod3)
505-456
312060-20576
pchisq(291484, df=49, lower.tail=FALSE)

lyme1$count<- as.integer(lyme1$count)
lyme1$Region<- as.integer(lyme1$Region)

#mod4<- glmm(count~year, random=list(~ 0 + Region), varcomps.names = c("1","2","3","4"), data=lyme1, family.glmm=poisson.glmm)
```

#Dataset sample 

```{r}
lyme1[1:10,]
lyme1[51:60,]
```

We can now examine a Poisson state-space model. To start with, lets restrict our model to Massachusetts.

The model takes the form,
$$X_t \sim N(X_{t-1},\sigma^2)$$

$$Y_t \sim Pois(exp(X_t))$$
```{r}

r1_data <- lyme1[which(lyme1$State=="Massachusetts"),]
r1_data$count
require(rbiips)
library(MCMCpack)
model_file = '/Users/gcgibson/Desktop/lyme/pois.bug' # BUGS model filename
cat(readLines(model_file), sep = "\n")

par(bty='l')
light_blue = rgb(.7, .7, 1)
light_red = rgb(1, .7, .7)


t_max = length(r1_data$count)
n_burn = 5000 # nb of burn-in/adaptation iterations
n_iter = 10000 # nb of iterations after burn-in
thin = 5 # thinning of MCMC outputs
n_part = 50 # nb of particles for the SMC
param_names = c('log_sigma') # names of the variables updated with MCMC (others are updated with SMC)
latent_names = c('x') # names of the variables updated with SMC and that need to be monitored

inits = list(-2)
data = list(t_max=t_max, y = r1_data$count, temp = r1_data$temp,  mean_x_init=log(1400))
model = biips_model(model_file, data=data,sample_data = FALSE)

obj_pmmh = biips_pmmh_init(model, param_names, inits=inits,
                           latent_names=latent_names) # creates a pmmh object


biips_pmmh_update(obj_pmmh, n_burn, n_part) # adaptation and burn-in iterations
out_pmmh = biips_pmmh_samples(obj_pmmh, n_iter, n_part, thin=thin) # samples

summ_pmmh = biips_summary(out_pmmh, probs=c(.025, .975))


p<- ggplot() 
p<- p+ geom_line(data = data.frame(x=seq(1,length(summ_pmmh$x$mean)),y=exp(summ_pmmh$x$mean)), aes(x = x, y = y), color = "red") +
  
  geom_line(data=data.frame(x=seq(1,length(r1_data$count)),y=r1_data$count), aes(x = x, y = y), color = "blue") +
#geom_ribbon(data=data.frame(x=seq(1,length(r1_data$count)),y=r1_data$count),aes(x=x,ymin=summ_pmmh$x$quant$`0.025`,ymax=summ_pmmh$x$quant$`0.975`),alpha=0.3)+
  xlab('data_date') +
  ylab('count')
print(p)




```


```{r}
r1_data <- lyme1[which(lyme1$State=="Massachusetts"),]
r1_data$count

r1_data$temp <- c(10,11,12,14,15,16,17,12,20,21)

require(rbiips)
library(MCMCpack)


model_file = '/Users/gcgibson/Desktop/lyme/pois_with_temp.bug' # BUGS model filename
cat(readLines(model_file), sep = "\n")

par(bty='l')
light_blue = rgb(.7, .7, 1)
light_red = rgb(1, .7, .7)


t_max = length(r1_data$count)
n_burn = 5000 # nb of burn-in/adaptation iterations
n_iter = 10000 # nb of iterations after burn-in
thin = 5 # thinning of MCMC outputs
n_part = 50 # nb of particles for the SMC
param_names = c('log_sigma') # names of the variables updated with MCMC (others are updated with SMC)
latent_names = c('x') # names of the variables updated with SMC and that need to be monitored

inits = list(-2)
data = list(t_max=t_max, y = r1_data$count, temp = r1_data$temp,  mean_x_init=log(1400))
model = biips_model(model_file, data=data,sample_data = FALSE)

obj_pmmh = biips_pmmh_init(model, param_names, inits=inits,
                           latent_names=latent_names) # creates a pmmh object


biips_pmmh_update(obj_pmmh, n_burn, n_part) # adaptation and burn-in iterations
out_pmmh = biips_pmmh_samples(obj_pmmh, n_iter, n_part, thin=thin) # samples

summ_pmmh = biips_summary(out_pmmh, probs=c(.025, .975))

```
We can now examine the latent state of disease in the presence of temperature fluctuations.
```{r}

p<- ggplot() 
p<- p+ geom_line(data = data.frame(x=seq(1,length(summ_pmmh$x$mean)),y=r1_data$temp*exp(summ_pmmh$x$mean)), aes(x = x, y = y), color = "red") +
  geom_line(data=data.frame(x=seq(1,length(r1_data$count)),y=r1_data$count), aes(x = x, y = y), color = "blue") +
#geom_ribbon(data=data.frame(x=seq(1,length(r1_data$count)),y=r1_data$count),aes(x=x,ymin=summ_pmmh$x$quant$`0.025`,ymax=summ_pmmh$x$quant$`0.975`),alpha=0.3)+
  xlab('data_date') +
  ylab('count')
print(p)


```
